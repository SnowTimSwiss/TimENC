name: Build and Release Binaries

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install dependencies
        shell: pwsh
        run: |
          pip install pyinstaller PySide6 cryptography argon2-cffi
      - name: Build EXE
        shell: pwsh
        run: |
          pyinstaller timenc.py `
            --onefile `
            --windowed `
            --name TimENC `
            --collect-all PySide6 `
            --collect-all cryptography `
            --collect-all argon2-cffi
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/TimENC.exe
          retention-days: 1

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: |
          pip install pyinstaller PySide6 cryptography argon2-cffi
      - name: Build macOS app
        run: |
          pyinstaller timenc.py \
            --onedir \
            --windowed \
            --name TimENC \
            --collect-all PySide6 \
            --collect-all cryptography \
            --collect-all argon2-cffi
      - name: Zip macOS app
        run: zip -r TimENC-macOS.zip dist/TimENC.app
      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-zip
          path: TimENC-macOS.zip
          retention-days: 1

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2 fuse-zlib wget
      - name: Install dependencies
        run: |
          pip install pyinstaller PySide6 cryptography argon2-cffi
      - name: Download linuxdeployqt
        run: |
          wget https://github.com/linuxdeploy/linuxdeploy-qt/releases/download/continuous/linuxdeploy-qt-x86_64.AppImage
          chmod +x linuxdeploy-qt-x86_64.AppImage
          mv linuxdeploy-qt-x86_64.AppImage linuxdeployqt
      - name: Build Linux app
        run: |
          pyinstaller timenc.py \
            --onedir \
            --windowed \
            --name TimENC \
            --distpath dist \
            --collect-all PySide6 \
            --collect-all cryptography \
            --collect-all argon2-cffi
      - name: Create AppImage
        run: |
          cd dist
          ../linuxdeployqt TimENC -bundle-non-qt-libs -appimage -no-copy-deps
          mv TimENC*.AppImage ../TimENC-Linux.AppImage
      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: TimENC-Linux.AppImage
          retention-days: 1

  upload-assets:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      - name: Upload to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.event.release.tag_name }} \
            windows-exe/TimENC.exe \
            macos-zip/TimENC-macOS.zip \
            linux-appimage/TimENC-Linux.AppImage \
            --clobber
