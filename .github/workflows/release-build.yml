name: Build Release Binaries
permissions:
  contents: write
on:
  release:
    types: [published]

jobs:
  build:
    name: Build ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            name: Windows
            pyinstaller_flags: --onefile --windowed --icon Images/TimENC-Icon.ico --name TimENC
          
          # macOS: Nutzt macos-14 (Apple Silicon) wie gewünscht
          - os: macos-14
            name: macOS
            pyinstaller_flags: --onedir --windowed --icon Images/TimENC-Icon.icns --name TimENC
          
          - os: ubuntu-latest
            name: Linux
            pyinstaller_flags: --onedir --icon Images/TimENC-Icon.png --name TimENC
    
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # FIX 1: Setzt die Shell explizit auf Bash, damit die 'if [ -f ... ]' Syntax auf Windows funktioniert.
      - name: Install Python deps
        shell: bash
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pyinstaller

      - name: Build with PyInstaller
        run: pyinstaller ${{ matrix.pyinstaller_flags }} timenc.py

      # FIX 2 (Teil 1): Logik zur Bereinigung von Versions-Tags, falls ungültige Zeichen oder kein numerischer Anfang vorhanden sind.
      - name: Extract and Validate version
        id: version
        shell: bash
        run: |
          TAG="${{ github.event.release.tag_name }}"
          RAW_VERSION="${TAG#v}"
          
          # SAFE_VERSION: Nur Buchstaben, Zahlen, Punkt und Bindestrich erlaubt (für Dateinamen/Setup-Header).
          SAFE_VERSION=$(echo "$RAW_VERSION" | sed 's/[^a-zA-Z0-9.-]/-/g')
          
          # DEB_VERSION: Muss mit einer Ziffer beginnen (sonst schlägt dpkg-deb fehl).
          DEB_VERSION="$RAW_VERSION"
          if [[ ! "$RAW_VERSION" =~ ^[0-9] ]]; then
            echo "::notice title=Invalid Version Tag::Tag does not start with a number. Using fallback version for DEB/RPM."
            DEB_VERSION="0.0.0-$SAFE_VERSION" # Fügt ein sicheres numerisches Präfix hinzu
          fi
          
          echo "safe_version=$SAFE_VERSION" >> $GITHUB_OUTPUT
          echo "deb_version=$DEB_VERSION" >> $GITHUB_OUTPUT

      # ---------------- WINDOWS ----------------
      - name: Install Inno Setup
        if: matrix.name == 'Windows'
        run: choco install innosetup -y

      - name: Build Windows artifacts
        if: matrix.name == 'Windows'
        shell: pwsh
        run: |
          # Nutzt den sicheren Versions-String für Dateinamen und Setup (fixiert ungültige Zeichen)
          $VERSION = "${{ steps.version.outputs.safe_version }}"
          $ORIGINAL_EXE = "dist/TimENC.exe"
          $PORTABLE_EXE = "TimENC-$VERSION-windows-x86_64-portable.exe"
          
          if (!(Test-Path $ORIGINAL_EXE)) { Write-Error "Exe not found at $ORIGINAL_EXE"; exit 1 }

          Copy-Item $ORIGINAL_EXE $PORTABLE_EXE

          $iss = @"
          [Setup]
          AppName=TimENC
          AppVersion=$VERSION
          AppPublisher=TimENC
          DefaultDirName={autopf}\TimENC
          UninstallDisplayName=TimENC
          OutputDir=.
          OutputBaseFilename=TimENC-$VERSION-windows-x86_64-setup
          Compression=lzma2
          SolidCompression=yes
          ArchitecturesAllowed=x64
          ArchitecturesInstallIn64BitMode=x64
          DisableProgramGroupPage=yes

          [Files]
          Source: "$ORIGINAL_EXE"; DestDir: "{app}"; DestName: "TimENC.exe"

          [Icons]
          Name: "{autoprograms}\TimENC"; Filename: "{app}\TimENC.exe"
          "@

          Set-Content -Path "setup.iss" -Value $iss
          & "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe" "setup.iss"
          Remove-Item "setup.iss"

      - name: Upload Windows
        if: matrix.name == 'Windows'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            TimENC-*-windows-x86_64-portable.exe
            TimENC-*-windows-x86_64-setup.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ---------------- macOS (Apple Silicon) ----------------
      - name: Build macOS DMG
        if: matrix.name == 'macOS'
        run: |
          VERSION="${{ steps.version.outputs.safe_version }}"
          if [ ! -d "dist/TimENC.app" ]; then echo "App Bundle not found!"; exit 1; fi

          mkdir -p dmg
          cp -R dist/TimENC.app dmg/
          ln -s /Applications dmg/Applications
          
          hdiutil create \
            -volname "TimENC $VERSION" \
            -srcfolder dmg \
            -ov \
            -format UDZO \
            "TimENC-$VERSION-macos-arm64.dmg"

      - name: Upload macOS
        if: matrix.name == 'macOS'
        uses: softprops/action-gh-release@v2
        with:
          files: TimENC-*-macos-arm64.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ---------------- LINUX ----------------
      - name: Install Linux tools
        if: matrix.name == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y fakeroot dpkg-dev rpm alien libfuse2 wget file desktop-file-utils

      - name: Build Linux packages
        if: matrix.name == 'Linux'
        run: |
          VERSION="${{ steps.version.outputs.deb_version }}"
          SAFE_FILENAME_VERSION="${{ steps.version.outputs.safe_version }}"

          # ---------- DEB ----------
          mkdir -p pkg/usr/bin pkg/opt/timenc pkg/DEBIAN
          cp -r dist/TimENC/* pkg/opt/timenc/
          # Stelle sicher, dass die Hauptdatei ausführbar ist
          chmod +x pkg/opt/timenc/TimENC

          cat << EOF > pkg/usr/bin/timenc
          #!/bin/bash
          /opt/timenc/TimENC "\$@"
          EOF
          chmod +x pkg/usr/bin/timenc

          cat << EOF > pkg/DEBIAN/control
          Package: timenc
          Version: $VERSION
          Architecture: amd64
          Maintainer: TimENC
          Description: Secure File Encryption Tool
          Depends: libc6
          Section: utils
          Priority: optional
          EOF

          # Post-Installation Script
          cat << EOF > pkg/DEBIAN/postinst
          #!/bin/bash
          chmod +x /opt/timenc/TimENC
          EOF
          chmod +x pkg/DEBIAN/postinst

          dpkg-deb --build pkg "TimENC-$SAFE_FILENAME_VERSION-linux-x86_64.deb"

          # ---------- RPM (Konvertierung) ----------
          fakeroot alien --to-rpm "TimENC-$SAFE_FILENAME_VERSION-linux-x86_64.deb" --scripts || true
          mv timenc-*.rpm "TimENC-$SAFE_FILENAME_VERSION-linux-x86_64.rpm" || true

          # ---------- AppImage ----------
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

          mkdir -p AppDir/usr/bin AppDir/usr/share/applications AppDir/usr/share/icons/hicolor/256x256/apps
          cp -r dist/TimENC/* AppDir/usr/bin/
          cp Images/TimENC-Icon.png AppDir/usr/share/icons/hicolor/256x256/apps/timenc.png
          
          # Stelle sicher, dass die Hauptdatei ausführbar ist
          chmod +x AppDir/usr/bin/TimENC

          cat << EOF > AppDir/usr/share/applications/timenc.desktop
          [Desktop Entry]
          Type=Application
          Name=TimENC
          Exec=TimENC
          Icon=timenc
          Categories=Utility;
          Terminal=false
          EOF

          cat << 'EOF' > AppDir/AppRun
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"
          exec "${HERE}/usr/bin/TimENC" "$@"
          EOF
          chmod +x AppDir/AppRun

          # Desktop und Icon auf oberster Ebene
          cp AppDir/usr/share/applications/timenc.desktop AppDir/
          cp AppDir/usr/share/icons/hicolor/256x256/apps/timenc.png AppDir/
          mv AppDir/timenc.png AppDir/AppDir.png

          ARCH=x86_64 ./appimagetool-x86_64.AppImage --no-appstream AppDir "TimENC-$SAFE_FILENAME_VERSION-linux-x86_64.AppImage"

      - name: Upload Linux
        if: matrix.name == 'Linux'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            TimENC-*-linux-x86_64.deb
            TimENC-*-linux-x86_64.rpm
            TimENC-*-linux-x86_64.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
