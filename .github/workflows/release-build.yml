name: Build and Release Binaries

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install dependencies
        shell: pwsh
        run: |
          pip install pyinstaller PySide6 cryptography argon2-cffi
      - name: Build EXE
        shell: pwsh
        run: |
          pyinstaller timenc.py `
            --onefile `
            --windowed `
            --name TimENC `
            --collect-all PySide6 `
            --collect-all cryptography `
            --collect-all argon2-cffi
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/TimENC.exe
          retention-days: 1

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: |
          pip install pyinstaller PySide6 cryptography argon2-cffi
      - name: Build macOS app
        run: |
          pyinstaller timenc.py \
            --onedir \
            --windowed \
            --name TimENC \
            --collect-all PySide6 \
            --collect-all cryptography \
            --collect-all argon2-cffi \
            --exclude-module PySide6.Qt3DAnimation \
            --exclude-module PySide6.Qt3DCore \
            --exclude-module PySide6.Qt3DExtras \
            --exclude-module PySide6.Qt3DInput \
            --exclude-module PySide6.Qt3DLogic \
            --exclude-module PySide6.Qt3DRender \
            --exclude-module PySide6.QtAsyncio \
            --exclude-module PySide6.QtBluetooth \
            --exclude-module PySide6.QtCharts \
            --exclude-module PySide6.QtConcurrent \
            --exclude-module PySide6.QtDataVisualization \
            --exclude-module PySide6.QtDBus \
            --exclude-module PySide6.QtDesigner \
            --exclude-module PySide6.QtGraphs \
            --exclude-module PySide6.QtGraphsWidgets \
            --exclude-module PySide6.QtHelp \
            --exclude-module PySide6.QtHttpServer \
            --exclude-module PySide6.QtLocation \
            --exclude-module PySide6.QtMultimedia \
            --exclude-module PySide6.QtMultimediaWidgets \
            --exclude-module PySide6.QtNetworkAuth \
            --exclude-module PySide6.QtNfc \
            --exclude-module PySide6.QtOpenGLWidgets \
            --exclude-module PySide6.QtPdf \
            --exclude-module PySide6.QtPdfWidgets \
            --exclude-module PySide6.QtPositioning \
            --exclude-module PySide6.QtPrintSupport \
            --exclude-module PySide6.QtQml \
            --exclude-module PySide6.QtQuick \
            --exclude-module PySide6.QtQuick3D \
            --exclude-module PySide6.QtQuickControls2 \
            --exclude-module PySide6.QtQuickTest \
            --exclude-module PySide6.QtQuickWidgets \
            --exclude-module PySide6.QtRemoteObjects \
            --exclude-module PySide6.QtScxml \
            --exclude-module PySide6.QtSensors \
            --exclude-module PySide6.QtSerialBus \
            --exclude-module PySide6.QtSerialPort \
            --exclude-module PySide6.QtSpatialAudio \
            --exclude-module PySide6.QtSql \
            --exclude-module PySide6.QtStateMachine \
            --exclude-module PySide6.QtSvg \
            --exclude-module PySide6.QtSvgWidgets \
            --exclude-module PySide6.QtTest \
            --exclude-module PySide6.QtTextToSpeech \
            --exclude-module PySide6.QtUiTools \
            --exclude-module PySide6.QtWebChannel \
            --exclude-module PySide6.QtWebEngineCore \
            --exclude-module PySide6.QtWebEngineQuick \
            --exclude-module PySide6.QtWebEngineWidgets \
            --exclude-module PySide6.QtWebSockets \
            --exclude-module PySide6.QtWebView \
            --exclude-module PySide6.QtXml \
            --clean
      - name: Zip macOS app
        run: zip -r TimENC-macOS.zip dist/TimENC.app
      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-zip
          path: TimENC-macOS.zip
          retention-days: 1

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2 wget
      - name: Install dependencies
        run: |
          pip install pyinstaller PySide6 cryptography argon2-cffi
      - name: Download linuxdeployqt
        run: |
          wget https://github.com/linuxdeploy/linuxdeploy-qt/releases/download/continuous/linuxdeploy-qt-x86_64.AppImage
          chmod +x linuxdeploy-qt-x86_64.AppImage
          mv linuxdeploy-qt-x86_64.AppImage linuxdeployqt
      - name: Build Linux app
        run: |
          pyinstaller timenc.py \
            --onedir \
            --windowed \
            --name TimENC \
            --distpath dist \
            --collect-all PySide6 \
            --collect-all cryptography \
            --collect-all argon2-cffi
      - name: Create AppImage
        run: |
          cd dist
          ../linuxdeployqt TimENC -bundle-non-qt-libs -appimage -no-copy-deps
          mv TimENC*.AppImage ../TimENC-Linux.AppImage
      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-appimage
          path: TimENC-Linux.AppImage
          retention-days: 1

  upload-assets:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      - name: Upload to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.event.release.tag_name }} \
            windows-exe/TimENC.exe \
            macos-zip/TimENC-macOS.zip \
            linux-appimage/TimENC-Linux.AppImage \
            --clobber
