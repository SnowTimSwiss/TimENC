name: Build Release Binaries
permissions:
  contents: write
on:
  release:
    types: [published]

jobs:
  build:
    name: Build ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            name: Windows
            pyinstaller_flags: --onefile --windowed --icon Images/TimENC-Icon.ico --name TimENC
          
          # Apple Silicon (M1/M2/M3) Build
          - os: macos-14
            name: macOS
            pyinstaller_flags: --onedir --windowed --icon Images/TimENC-Icon.icns --name TimENC
          
          - os: ubuntu-latest
            name: Linux
            pyinstaller_flags: --onedir --icon Images/TimENC-Icon.png --name TimENC
    
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pyinstaller

      - name: Build with PyInstaller
        run: pyinstaller ${{ matrix.pyinstaller_flags }} timenc.py

      - name: Extract version
        id: version
        shell: bash
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # ---------------- WINDOWS ----------------
      - name: Install Inno Setup
        if: matrix.name == 'Windows'
        run: choco install innosetup -y

      - name: Build Windows artifacts
        if: matrix.name == 'Windows'
        shell: pwsh
        run: |
          $VERSION = "${{ steps.version.outputs.version }}"
          $ORIGINAL_EXE = "dist/TimENC.exe"
          $PORTABLE_EXE = "TimENC-$VERSION-windows-x86_64-portable.exe"
          $SETUP_EXE = "TimENC-$VERSION-windows-x86_64-setup.exe"

          if (!(Test-Path $ORIGINAL_EXE)) { Write-Error "Exe not found at $ORIGINAL_EXE"; exit 1 }

          Copy-Item $ORIGINAL_EXE $PORTABLE_EXE

          $iss = @"
          [Setup]
          AppName=TimENC
          AppVersion=$VERSION
          AppPublisher=TimENC
          DefaultDirName={autopf}\TimENC
          UninstallDisplayName=TimENC
          OutputDir=.
          OutputBaseFilename=TimENC-$VERSION-windows-x86_64-setup
          Compression=lzma2
          SolidCompression=yes
          ArchitecturesAllowed=x64
          ArchitecturesInstallIn64BitMode=x64
          DisableProgramGroupPage=yes

          [Files]
          Source: "$ORIGINAL_EXE"; DestDir: "{app}"; DestName: "TimENC.exe"

          [Icons]
          Name: "{autoprograms}\TimENC"; Filename: "{app}\TimENC.exe"
          "@

          Set-Content -Path "setup.iss" -Value $iss
          & "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe" "setup.iss"
          Remove-Item "setup.iss"

      - name: Upload Windows
        if: matrix.name == 'Windows'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            TimENC-*-windows-x86_64-portable.exe
            TimENC-*-windows-x86_64-setup.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ---------------- macOS (Apple Silicon) ----------------
      - name: Build macOS DMG
        if: matrix.name == 'macOS'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [ ! -d "dist/TimENC.app" ]; then echo "App Bundle not found!"; exit 1; fi

          mkdir -p dmg
          cp -R dist/TimENC.app dmg/
          ln -s /Applications dmg/Applications
          
          # Erstellt ein DMG speziell benannt für arm64
          hdiutil create \
            -volname "TimENC $VERSION" \
            -srcfolder dmg \
            -ov \
            -format UDZO \
            "TimENC-$VERSION-macos-arm64.dmg"

      - name: Upload macOS
        if: matrix.name == 'macOS'
        uses: softprops/action-gh-release@v2
        with:
          files: TimENC-*-macos-arm64.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ---------------- LINUX ----------------
      - name: Install Linux tools
        if: matrix.name == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y fakeroot dpkg-dev rpm alien libfuse2 wget file

      - name: Build Linux packages
        if: matrix.name == 'Linux'
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # DEB
          mkdir -p pkg/usr/bin pkg/opt/timenc pkg/DEBIAN
          cp -r dist/TimENC/* pkg/opt/timenc/
          echo -e "#!/bin/bash\n/opt/timenc/TimENC \"\$@\"" > pkg/usr/bin/timenc
          chmod +x pkg/usr/bin/timenc
          
          cat << EOF > pkg/DEBIAN/control
          Package: timenc
          Version: $VERSION
          Architecture: amd64
          Maintainer: TimENC
          Description: Secure File Encryption Tool
          EOF
          
          dpkg-deb --build pkg "TimENC-$VERSION-linux-x86_64.deb"

          # RPM
          fakeroot alien --to-rpm "TimENC-$VERSION-linux-x86_64.deb" --scripts || true
          mv timenc-*.rpm "TimENC-$VERSION-linux-x86_64.rpm" || true

          # AppImage
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

          mkdir -p AppDir/usr/bin AppDir/usr/share/applications AppDir/usr/share/icons/hicolor/256x256/apps
          cp -r dist/TimENC/* AppDir/usr/bin/
          cp Images/TimENC-Icon.png AppDir/usr/share/icons/hicolor/256x256/apps/timenc.png

          cat << EOF > AppDir/usr/share/applications/timenc.desktop
          [Desktop Entry]
          Type=Application
          Name=TimENC
          Exec=TimENC
          Icon=timenc
          Categories=Utility;
          EOF

          cat << 'EOF' > AppDir/AppRun
          #!/bin/bash
          exec "$(dirname "$0")/usr/bin/TimENC" "$@"
          EOF
          chmod +x AppDir/AppRun

          # Fix für GitHub Actions Environment
          ARCH=x86_64 ./appimagetool-x86_64.AppImage AppDir "TimENC-$VERSION-linux-x86_64.AppImage"

      - name: Upload Linux
        if: matrix.name == 'Linux'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            TimENC-*-linux-x86_64.deb
            TimENC-*-linux-x86_64.rpm
            TimENC-*-linux-x86_64.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
